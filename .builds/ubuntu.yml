image: ubuntu/bionic

secrets:
  - 42bb7f41-956c-4cb8-a685-2fa6e59f5f14
  - 63991352-48fc-43df-acb7-697c7f43c77b
  - 79d42130-a326-4eb1-9195-6034eb5d6d82
  - 6166d74e-9ca5-43f1-af92-1254f82c747f

packages:
  - curl
  - unzip

tasks:
  - mirror-to-github: |
      cd ~/caophim
      mkdir -p ~/.ssh
      echo -e "\nHost github.com\n  IdentityFile /home/build/.ssh/42bb7f41-956c-4cb8-a685-2fa6e59f5f14\n  IdentitiesOnly yes\n  BatchMode yes" >> ~/.ssh/config
      echo "github.com ssh-rsa AAAAB3NzaC1yc2EAAAABIwAAAQEAq2A7hRGmdnm9tUDbO9IDSwBK6TbQa+PXYPCPy6rbTrTtw7PHkccKrpp0yVhp5HdEIcKr6pLlVDBfOLX9QUsyCOV0wzfjIJNlGEYsdlLJizHhbn2mUjvSAHQqZETYP81eFzLQNnPHt4EVVUh7VfDESU84KezmD5QlWpXLmvU31/yMf+Se8xhHTvKSCZIFImWwoG6mbUoWf9nzpIoaSjB+weqqUUmpaaasXVal72J+UX2B+2RPW3RcT0eOzQgqlJL3RKrTJvdsjE3JEAvGq3lGHSZXy28G3skua2SmVi/w4yCE6gbODqnTWlg7+wC604ydGXA8VJiS5ap43JXiUFFAaQ==" >> ~/.ssh/known_hosts
      git remote add github git@github.com:nhanb/caophim.git
      git push -f github '*:*' --follow-tags

  - build: |
      curl -L 'https://github.com/nim-lang/nightlies/releases/download/2020-02-24-devel-3dad130/nim-1.1.1-linux_x64.tar.xz' -o nim.tar.xz
      tar -xf nim.tar.xz
      cd nim-1.1.1
      sudo sh install.sh /usr/bin
      sudo cp bin/* /usr/bin

      curl -L 'https://sqlite.org/2020/sqlite-amalgamation-3310100.zip' -o sqlite.zip
      unzip sqlite.zip
      cd sqlite-amalgamation-3310100
      gcc -c -DSQLITE_THREADSAFE=0 sqlite3.c -o ~/caophim/sqlite3.o

      cd ~/caophim
      nimble build --accept

  - package: |
      cd ~/caophim/
      mkdir caophim-dist
      cp -r public caophim-dist/public
      cp -r aws caophim-dist/aws
      cp config.ini.example caophim-dist/
      cp bin/* caophim-dist/
      tar -czvf caophim-linux64.tar.gz caophim-dist

  # Builds.sr.ht doesn't support tag or even branch detection yet:
  # > https://todo.sr.ht/~sircmpwn/builds.sr.ht/170
  - check-release: |
      cd caophim
      export BRANCH=$(git rev-parse --abbrev-ref HEAD)
      if [ "$(git rev-parse master)" == "$(git rev-parse HEAD)" ]; then
        echo "Is master. Proceeding to release."
      else
        complete-build
      fi

  - deploy: |
      # download & setup the `hub` client
      #curl -L 'https://github.com/github/hub/releases/download/v2.14.1/hub-linux-amd64-2.14.1.tgz' -o hub.tgz
      #tar -xf hub.tgz
      #sudo cp hub-linux-amd64-2.14.1/bin/hub /usr/bin/
      #cd caophim
      #export TAG="v0.$(date +'%Y.%m.%d-%H%M')"
      # this used to work but now doesn't for some reason:
      #hub release create -a caophim-linux64.tar.gz "$TAG" -m "$TAG"

      cd caophim
      scp -i ~/.ssh/6166d74e-9ca5-43f1-af92-1254f82c747f caophim-linux64.tar.gz ubuntu@caophim.net:/home/ubuntu/
      ssh -i ~/.ssh/6166d74e-9ca5-43f1-af92-1254f82c747f ubuntu@caophim.net "
        #wget -O caophim-linux64.tar.gz https://github.com/nhanb/caophim/releases/download/${TAG}/caophim-linux64.tar.gz
        tar -xf caophim-linux64.tar.gz
        sudo systemctl restart caophim
      "

artifacts:
  - caophim/caophim-linux64.tar.gz
